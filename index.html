<!DOCTYPE html>
<html>
<head>
    <title>Geo Web 2024 Assignment</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        html, body {
            height: 100%; /* Ensure the body takes full height */
            margin: 0; /* Remove default margin */
        }
        #map { 
            height: 100%; /* Make the map take full height */
        }
        #styleSelector {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: white;
            border: 1px solid #ccc;
            padding: 10px;
            z-index: 1000;
        }
        #refreshButton {
            position: absolute; /* Position the button */
            bottom: 20px; /* Distance from the bottom */
            right: 20px; /* Distance from the right */
            padding: 10px 15px; /* Button padding */
            background-color: #007bff; /* Button color */
            color: white; /* Text color */
            border: none; /* Remove border */
            border-radius: 5px; /* Rounded corners */
            cursor: pointer; /* Pointer cursor on hover */
            z-index: 1000; /* Ensure button is on top */
        }
        #lastRefresh {
            position: absolute; /* Position the text */
            bottom: 60px; /* Distance from the bottom */
            right: 20px; /* Distance from the right */
            color: black; /* Text color */
            font-size: 14px; /* Font size */
            z-index: 1000; /* Ensure text is on top */
        }
        #menuButton {
            position: absolute; /* Position the button */
            top: 20px; /* Distance from the top */
            left: 20px; /* Distance from the left */
            padding: 10px 15px; /* Button padding */
            background-color: #007bff; /* Button color */
            color: white; /* Text color */
            border: none; /* Remove border */
            border-radius: 5px; /* Rounded corners */
            cursor: pointer; /* Pointer cursor on hover */
            z-index: 1000; /* Ensure button is on top */
        }
        #sideMenu {
            position: fixed; /* Fixed position to stay in place */
            top: 0; /* Align to the top */
            left: 0; /* Align to the left */
            width: 250px; /* Set width of the sidebar */
            height: 100%; /* Full height */
            background-color: white; /* White background */
            color: black; /* Black text color */
            padding: 20px; /* Padding inside the sidebar */
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5); /* Shadow for depth */
            transition: transform 0.3s ease; /* Smooth transition */
            transform: translateX(-100%); /* Initially hidden */
            z-index: 1000; /* Ensure it is on top */
        }

        #sideMenu.show {
            transform: translateX(0); /* Show the sidebar */
        }

        #fullExtentButton {
            position: absolute; /* Position the button */
            bottom: 100px; /* Distance from the bottom */
            right: 20px; /* Distance from the right */
            padding: 10px 15px; /* Button padding */
            background-color: #007bff; /* Button color */
            color: white; /* Text color */
            border: none; /* Remove border */
            border-radius: 5px; /* Rounded corners */
            cursor: pointer; /* Pointer cursor on hover */
            z-index: 1000; /* Ensure button is on top */
        }

    </style>
</head>
<body>
    <div id="map"></div>
    <div id="styleSelector">
        <label for="mapStyles">Choose Map Style:</label>
        <select id="mapStyles">
            <option value="streets">Streets</option>
            <option value="dark">Dark</option>
            <option value="terrain">Terrain</option>
            <option value="outdoor">Outdoor</option>
            <option value="trafic">Trafic</option>

        </select>
    </div>
    <button id="refreshButton">Refresh</button>
    <div id="lastRefresh">Last Refresh: Never</div>
    <button id="menuButton">Open Menu</button>
    <button id="fullExtentButton">Full Extent</button>
    <div id="sideMenu">
        <h3 style="color: black;">Menu</h3>
        <ul>
            <li>
                <label>
                    <input type="checkbox" id="toggleBusPoints" checked>
                    Show Bus Points
                </label>
            </li>
            <li>
                <label for="districtSelect">Select District:</label>
                <select id="districtSelect">
                    <option value="0">-- Select District --</option>
                    <option value="11">District 11</option>
                    <option value="15">District 15</option>
                </select>
            </li>
            <li>
                <label for="busLineInput">Enter Bus Line:</label>
                <input type="text" id="busLineInput" placeholder="Bus Line">
                <button id="selectBusLineButton">Select Bus Line</button>
                <button id="showAllBusesButton">Show All Buses</button>
            </li>
            <li>
                <label for="municipalitySelect">Select Municipality:</label>
                <select id="municipalitySelect">
                    <option value="0">-- Select Municipality --</option>
                    <option value="1101">Municipality 1101</option>
                    <option value="1102">Municipality 1102</option>
                    <option value="1105">Municipality 1105</option>
                    <option value="1106">Municipality 1106</option>
                    <option value="1107">Municipality 1107</option>
                    <option value="1109">Municipality 1109</option>
                    <option value="1110">Municipality 1110</option>
                    <option value="1111">Municipality 1111</option>
                    <option value="1112">Municipality 1112</option>
                    <option value="1113">Municipality 1113</option>
                    <option value="1114">Municipality 1114</option>
                    <option value="1115">Municipality 1115</option>
                    <option value="1116">Municipality 1116</option>
                    <option value="1502">Municipality 1502</option>
                    <option value="1503">Municipality 1503</option>
                    <option value="1504">Municipality 1504</option>
                    <option value="1506">Municipality 1506</option>
                    <option value="1507">Municipality 1507</option>
                    <option value="1508">Municipality 1508</option>
                    <option value="1510">Municipality 1510</option>
                    <option value="1511">Municipality 1511</option>
                    <option value="1512">Municipality 1512</option>
                    <option value="712">Municipality 712</option>
                </select>
            </li>
        </ul>
    </div>

    <script>
        var map = L.map('map', {
            zoomControl: false // Disable default zoom control
        }).setView([38.736946, -9.142685], 13); // Initialize the map with a view

        var currentLayer = L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoidmZjcnV6IiwiYSI6ImNtMzRuaDM5MjAxazIybHF0MnRkcGR5dDUifQ.ynftZ9Rp3L9yS1l2lhO5ZQ', {
            maxZoom: 19,
        }).addTo(map); // Add the default tile layer


        var zoomControl = L.control.zoom({
            position: 'bottomleft' // Set position to bottom left
        }).addTo(map);

        var lastRefreshTime = 'Never'; // Initialize last refresh time
        var vehicleMarkers = {}; // Object to hold vehicle markers by vehicle ID
        var busStopMarkers = {}; // Change from array to object

        function updateLastRefresh() {
            lastRefreshTime = new Date().toLocaleTimeString(); // Update to current time
            document.getElementById('lastRefresh').innerText = 'Last Refresh: ' + lastRefreshTime; // Update text
        }

        function loadBusPositions() {
            fetch('https://api.cmet.pt/patterns/4710_0_1')
            .then(response => response.json())
            .then(data => {
                //console.log(data);
            })

            fetch('https://api.cmet.pt/vehicles')
            .then(response => response.json())
            .then(data => {

                const newMarkers = {}; // Temporary object to hold new markers

                if (Array.isArray(data) && data.length > 0) { // Check if data is valid
                    data.forEach(vehicle => {
                        if (vehicle.lat && vehicle.lon) { // Check for coordinates
                            const vehicleId = vehicle.id; // Assuming vehicle.id is unique

                            // Check if the marker already exists
                            if (vehicleId in vehicleMarkers) {
                                // Update the existing marker's position if it has changed
                                const existingMarker = vehicleMarkers[vehicleId];
                                const newLatLng = L.latLng(vehicle.lat, vehicle.lon);
                                if (existingMarker.getLatLng().lat !== vehicle.lat || existingMarker.getLatLng().lng !== vehicle.lon) {
                                    existingMarker.setLatLng(newLatLng); // Update position
                                }
                            } else {
                                // Create a new marker if it doesn't exist
                                const newMarker = L.marker([vehicle.lat, vehicle.lon]).addTo(map);
                                newMarkers[vehicleId] = newMarker; // Store the new marker
                                
                                // Create a popup with vehicle information
                                newMarker.options.id = vehicle.id || 'N/A'; // Save the vehicle id into the marker
                                newMarker.options.line = vehicle.line_id || 'N/A'; // Save the vehicle line into the marker
                                newMarker.options.latitude = vehicle.lat || 'N/A'; // Save the vehicle latitude into the marker
                                newMarker.options.longitude = vehicle.lon || 'N/A'; // Save the vehicle longitude into the marker
                                newMarker.options.speed = vehicle.speed || 'N/A'; // Save the vehicle speed into the marker
                                newMarker.options.status = vehicle.current_status || 'N/A'; // Save the vehicle status into the marker
                                newMarker.options.stopId = vehicle.stop_id ? `<a href="javascript:void(0);" onclick="selectBusStopById(${vehicle.stop_id - 0})">${vehicle.stop_id - 0}</a>` : 'N/A'; // Save the vehicle stop id into the marker
                                var popupContent = `
                                    <strong>Id:</strong> ${newMarker.options.id}<br>
                                    <strong>Line:</strong> ${newMarker.options.line}<br>
                                    <strong>Latitude:</strong> ${newMarker.options.latitude}<br>
                                    <strong>Longitude:</strong> ${newMarker.options.longitude}<br>
                                    <strong>Speed:</strong> ${newMarker.options.speed}<br>
                                    <strong>Status:</strong> ${newMarker.options.status}<br>
                                    <strong>Stop id:</strong> ${newMarker.options.stopId}
                                `;
                                newMarker.bindPopup(popupContent); // Bind the popup to the new marker
                            }
                        } else {
                            //console.warn('Missing coordinates for vehicle:', vehicle);
                        }
                    });
                } else {
                    console.warn('No vehicles found or invalid API response.');
                }

                // Update the markers object with new markers
                vehicleMarkers = { ...vehicleMarkers, ...newMarkers }; // Merge new markers into the existing markers object
                updateLastRefresh(); // Update last refresh time after loading data

                const showBusPoints = document.getElementById('toggleBusPoints').checked;
                if (!showBusPoints) {
                    Object.values(newMarkers).forEach(marker => {
                        map.removeLayer(marker); // Remove marker from the map if checkbox is unchecked
                    });
                }
            })
            .catch(error => console.error('API Error:', error));
        }

        function loadBusStops() {
            fetch('data.php') // Fetch bus stops from the PHP script
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Fetched Data:', data); // Log the fetched data
                    // Clear existing bus stop markers from the map
                    Object.values(busStopMarkers).forEach(marker => map.removeLayer(marker)); // Remove old markers from the map
                    busStopMarkers = {}; // Clear the busStopMarkers object

                    if (data.features && data.features.length > 0) { // Check if data is valid
                        data.features.forEach(stop => {
                            var coords = stop.geometry.coordinates;
                            const district = stop.properties.district; // Assuming each stop has a district property
                            const municipality = stop.properties.municipality;
                            const stopId = stop.properties.id; // Get the stop ID

                            // Create a new circle marker for bus stops
                            const newMarker = L.circleMarker([coords[1], coords[0]], {
                                radius: 5, // Size of the circle
                                fillColor: 'red', // Fill color
                                color: 'red', // Border color
                                weight: 1, // Border weight
                                opacity: 1, // Border opacity
                                fillOpacity: 1 // Fill opacity
                            });

                            // Set the properties on the marker
                            newMarker.district = district;
                            newMarker.municipality = municipality;
                            newMarker.stopId = stopId; // Store the stop ID

                            // Add the marker to the map
                            newMarker.addTo(map);
                            busStopMarkers[stopId] = newMarker; // Store the new marker using stop ID as key

                            // Create a popup with bus stop information
                            var popupContent = `
                                <strong>Stop Name:</strong> ${stop.properties.name || 'N/A'}<br>
                                <strong>District:</strong> ${district || 'N/A'}<br>
                                <strong>Municipality:</strong> ${municipality || 'N/A'}<br>
                                <strong>Additional Info:</strong> ${stop.properties.routes || 'N/A'}
                            `;
                            newMarker.bindPopup(popupContent); // Bind the popup to the new marker
                            //console.log("stop id" + stopId);
                        });
                    } else {
                        //console.warn('No bus stops found or invalid API response.');
                    }
                })
                .catch(error => console.error('API Error:', error));
        }

        function changeMapStyle(style) {
            // Remove the current layer
            map.removeLayer(currentLayer);

            // Set the new tile layer based on the selected style
            switch (style) {
                case 'dark':
                    currentLayer = L.tileLayer('https://api.mapbox.com/styles/v1/vfcruz/cm34p81mt00ac01o05joohvdv/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoidmZjcnV6IiwiYSI6ImNtMzRuaDM5MjAxazIybHF0MnRkcGR5dDUifQ.ynftZ9Rp3L9yS1l2lhO5ZQ', {
                        maxZoom: 19,
                    });
                    break;
                case 'terrain':
                currentLayer = L.tileLayer('https://api.mapbox.com/styles/v1/vfcruz/cm34p32b900mx01qz7gvs5lne/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoidmZjcnV6IiwiYSI6ImNtMzRuaDM5MjAxazIybHF0MnRkcGR5dDUifQ.ynftZ9Rp3L9yS1l2lhO5ZQ', {
                        maxZoom: 20,
                    });
                    break;
                case 'outdoor':
                    currentLayer = L.tileLayer('https://api.mapbox.com/styles/v1/vfcruz/cm34oxww300aa01o0cfn83m5h/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoidmZjcnV6IiwiYSI6ImNtMzRuaDM5MjAxazIybHF0MnRkcGR5dDUifQ.ynftZ9Rp3L9yS1l2lhO5ZQ', {
                        maxZoom: 20,
                    });
                    break;
                case 'trafic':
                    currentLayer = L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/navigation-day-v1/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoidmZjcnV6IiwiYSI6ImNtMzRuaDM5MjAxazIybHF0MnRkcGR5dDUifQ.ynftZ9Rp3L9yS1l2lhO5ZQ', {
                    maxZoom: 20,
                    });
                break;
                case 'streets':
                    currentLayer = L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoidmZjcnV6IiwiYSI6ImNtMzRuaDM5MjAxazIybHF0MnRkcGR5dDUifQ.ynftZ9Rp3L9yS1l2lhO5ZQ', {
                    maxZoom: 20,
                    });
                break;
                /*BACKUP
                case 'streets':
                default:
                    currentLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                    });
                    break;
                */
            }
            currentLayer.addTo(map);
        }

        // Call loadBusStops to fetch and display bus stops
        loadBusStops(); 


        document.getElementById('refreshButton').addEventListener('click', loadBusPositions); // Add click event to button

        setInterval(loadBusPositions, 10000); // Fetch every 10 seconds

        loadBusPositions(); 

        document.getElementById('menuButton').addEventListener('click', () => {
            const sideMenu = document.getElementById('sideMenu');
            sideMenu.classList.toggle('show'); // Toggle the 'show' class
        });

        document.getElementById('map').addEventListener('click', () => {
            const sideMenu = document.getElementById('sideMenu');
            sideMenu.classList.remove('show'); // Remove the 'show' class
        });

        document.getElementById('toggleBusPoints').addEventListener('change', (event) => {
            if (event.target.checked) {
                // Show bus points
                Object.values(vehicleMarkers).forEach(marker => {
                    marker.addTo(map); // Add marker to the map
                });
            } else {
                // Hide bus points
                Object.values(vehicleMarkers).forEach(marker => {
                    map.removeLayer(marker); // Remove marker from the map
                });
            }
        });

        document.getElementById('districtSelect').addEventListener('change', () => {
            const selectedDistrict = parseInt(document.getElementById('districtSelect').value, 10); // Parse selected district as an integer
        
            // Show or hide markers based on the selected district
            Object.values(busStopMarkers).forEach(marker => {
                const matchesDistrict = selectedDistrict === 0 || marker.district === selectedDistrict; // Check district match
                
                if (matchesDistrict) {
                    if (!map.hasLayer(marker)) {
                        marker.addTo(map); // Show marker if it matches
                    }
                } else {
                    if (map.hasLayer(marker)) {
                        map.removeLayer(marker); // Remove marker if it doesn't match
                    }
                }
            });
        });

        document.getElementById('municipalitySelect').addEventListener('change', () => {
            const selectedMunicipality = parseInt(document.getElementById('municipalitySelect').value, 10); // Parse selected district as an integer
        
            // Show or hide markers based on the selected Municipality
            Object.values(busStopMarkers).forEach(marker => {
                const matchesMunicipality = selectedMunicipality === 0 || marker.municipality === selectedMunicipality; // Check district match
                
                if (matchesMunicipality) {
                    if (!map.hasLayer(marker)) {
                        marker.addTo(map); // Show marker if it matches
                    }
                } else {
                    if (map.hasLayer(marker)) {
                        map.removeLayer(marker); // Remove marker if it doesn't match
                    }
                }
            });
        });

        document.getElementById('fullExtentButton').addEventListener('click', () => {
            const visibleMarkers = []; // Array to hold currently visible markers

            // Check bus stop markers
            Object.values(busStopMarkers).forEach(marker => {
                if (map.hasLayer(marker)) {
                    visibleMarkers.push(marker); // Add to visible markers if currently displayed
                }
            });

            // Check vehicle markers
            Object.values(vehicleMarkers).forEach(marker => {
                if (map.hasLayer(marker)) {
                    visibleMarkers.push(marker); // Add to visible markers if currently displayed
                }
            });

            // Adjust the map view to fit the bounds of the visible markers
            if (visibleMarkers.length > 0) {
                const group = new L.featureGroup(visibleMarkers); // Create a feature group from visible markers
                map.fitBounds(group.getBounds()); // Adjust the map view to fit the bounds of the visible markers
            } else {
                alert("No visible points to focus on."); // Alert if no markers are visible
            }
        });

        function selectBusLineId(stopId) {
            Object.values(vehicleMarkers).forEach(marker => {
                if(marker.options.line === stopId) {
                    marker.addTo(map);
                } else {
                    map.removeLayer(marker);
                }
            });
        }

        document.getElementById('selectBusLineButton').addEventListener('click', () => {
            const lineId = document.getElementById('busLineInput').value; // Get the input value
            selectBusLineId(lineId); // Call the function to select the bus stop
        });

        document.getElementById('showAllBusesButton').addEventListener('click', () => {
            Object.values(vehicleMarkers).forEach(marker => {
                map.addLayer(marker);
        })});

        // Event listener for the dropdown menu
        document.getElementById('mapStyles').addEventListener('change', function() {
            changeMapStyle(this.value);
        });

    </script>
</body>
</html>